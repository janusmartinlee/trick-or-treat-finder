name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
    paths:
      - 'application/**'
      - '.github/workflows/**'
      - '.releaserc.json'
      - '!application/**.md'
  pull_request:
    branches: [ main, master ]
    paths:
      - 'application/**'
      - '.github/workflows/**'
      - '.releaserc.json'
      - '!application/**.md'

permissions:
  contents: write
  issues: write
  pull-requests: write
  packages: write

jobs:
  test-frontend:
    name: Test Flutter Frontend
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
        cache: true
    
    - name: Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          application/.dart_tool
          application/.packages
        key: ${{ runner.os }}-pub-v2-${{ hashFiles('application/pubspec.lock', 'application/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pub-v2-
          ${{ runner.os }}-pub-
    
    - name: Install dependencies
      run: flutter pub get
      working-directory: ./application
    
    - name: Analyze code
      run: flutter analyze
      working-directory: ./application
    
    - name: Run tests
      run: flutter test --concurrency=4
      working-directory: ./application
    
    - name: Check formatting
      run: dart format --output=none --set-exit-if-changed .
      working-directory: ./application

  build-android:
    name: Build Android Frontend
    needs: test-frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
        cache: true
    
    - name: Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          application/.dart_tool
          application/.packages
        key: ${{ runner.os }}-pub-v2-${{ hashFiles('application/pubspec.lock', 'application/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pub-v2-
          ${{ runner.os }}-pub-
    
    - name: Cache Gradle dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.gradle/caches
          ~/.gradle/wrapper
          application/android/.gradle
          application/android/app/.gradle
        key: ${{ runner.os }}-gradle-v2-${{ hashFiles('application/android/gradle/wrapper/gradle-wrapper.properties', 'application/android/build.gradle.kts', 'application/android/app/build.gradle.kts') }}
        restore-keys: |
          ${{ runner.os }}-gradle-v2-
          ${{ runner.os }}-gradle-
    
    - name: Install dependencies
      run: flutter pub get
      working-directory: ./application
    
    - name: Build Android APK
      run: flutter build apk --release --split-per-abi
      working-directory: ./application
    
    - name: Upload Android artifacts
      uses: actions/upload-artifact@v4
      with:
        name: android-apk
        path: application/build/app/outputs/flutter-apk/*.apk

  build-web:
    name: Build Web Frontend
    needs: test-frontend
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
        cache: true
    
    - name: Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~/.pub-cache
          application/.dart_tool
        key: ${{ runner.os }}-pub-v2-${{ hashFiles('application/pubspec.lock', 'application/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pub-
    
    - name: Install dependencies
      run: flutter pub get
      working-directory: ./application
    
    - name: Enable web support and configure
      run: |
        flutter config --enable-web
        flutter create . --platforms web
      working-directory: ./application
    
    - name: Build Web
      run: flutter build web --release
      working-directory: ./application
    
    - name: Upload Web artifacts
      uses: actions/upload-artifact@v4
      with:
        name: web-build
        path: application/build/web/

  build-windows:
    name: Build Windows Frontend
    needs: test-frontend
    runs-on: windows-2022
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
        cache: true

    - name: Cache pub dependencies
      uses: actions/cache@v4
      with:
        path: |
          ~\AppData\Local\Pub\Cache
          application\.dart_tool
        key: ${{ runner.os }}-pub-v2-${{ hashFiles('application/pubspec.lock', 'application/pubspec.yaml') }}
        restore-keys: |
          ${{ runner.os }}-pub-

    - name: Install dependencies
      run: flutter pub get
      working-directory: .\application

    - name: Build Windows app
      run: flutter build windows --release --verbose
      working-directory: .\application    - name: Create Windows distribution package
      run: |
        New-Item -ItemType Directory -Force -Path "windows-distribution"
        Copy-Item -Recurse -Path "application\build\windows\x64\runner\Release\*" -Destination "windows-distribution\"
        Compress-Archive -Path "windows-distribution\*" -DestinationPath "TrickOrTreatFinder-Windows.zip"
      shell: powershell
    
    - name: Upload Windows artifacts
      uses: actions/upload-artifact@v4
      with:
        name: windows-app
        path: TrickOrTreatFinder-Windows.zip

  # Placeholder for backend tests when backend is added
  test-backend:
    name: Test Backend (Placeholder)
    runs-on: ubuntu-latest
    if: false  # Disabled until backend is implemented
    
    steps:
    - uses: actions/checkout@v4
    - name: Placeholder for backend tests
      run: echo "Backend tests will be added here"

  release:
    name: Release
    needs: [test-frontend, build-android, build-web, build-windows]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
        cache: true
    
    - name: Cache semantic-release global packages
      uses: actions/cache@v4
      with:
        path: ~/.npm
        key: ${{ runner.os }}-semantic-release-global
        restore-keys: |
          ${{ runner.os }}-semantic-release-
    
    - name: Install semantic-release globally
      run: |
        npm install -g semantic-release @semantic-release/changelog @semantic-release/git @semantic-release/github @semantic-release/exec
    
    - name: Download Android artifacts
      uses: actions/download-artifact@v4
      with:
        name: android-apk
        path: application/build/app/outputs/flutter-apk/
    
    - name: Download Web artifacts
      uses: actions/download-artifact@v4
      with:
        name: web-build
        path: application/build/web/
    
    - name: Download Windows artifacts
      uses: actions/download-artifact@v4
      with:
        name: windows-app
        path: ./
    
    - name: List downloaded artifacts (debug)
      run: |
        echo "Android APK artifacts:"
        ls -la application/build/app/outputs/flutter-apk/ || echo "Android artifacts directory not found"
        echo "Web artifacts:"
        ls -la application/build/web/ || echo "Web artifacts directory not found"
        echo "Windows artifacts:"
        ls -la *.zip || echo "Windows zip file not found"
    
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git config --get remote.origin.url
        git status
    
    - name: Release
      run: semantic-release --debug
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
